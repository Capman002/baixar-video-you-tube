<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Baixar V√≠deo - Download de V√≠deos Profissional</title>
    <meta
      name="description"
      content="Baixe v√≠deos do YouTube, Instagram, TikTok, X e mais em alta qualidade. Suporte a MP4, MP3 e playlists."
    />

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
      rel="stylesheet"
    />

    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ["Inter", "system-ui", "sans-serif"],
            },
            colors: {
              dark: {
                900: "#0a0a0a",
                800: "#121212",
                700: "#1a1a1a",
                600: "#242424",
              },
            },
            animation: {
              "pulse-slow": "pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite",
              shimmer: "shimmer 2s linear infinite",
            },
            keyframes: {
              shimmer: {
                "0%": { backgroundPosition: "-200% 0" },
                "100%": { backgroundPosition: "200% 0" },
              },
            },
          },
        },
      };
    </script>

    <style>
      * {
        font-family: "Inter", sans-serif;
      }

      body {
        background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
        min-height: 100vh;
      }

      /* Glass morphism */
      .glass {
        background: rgba(255, 255, 255, 0.03);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.08);
      }

      .glass-subtle {
        background: rgba(255, 255, 255, 0.02);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.05);
      }

      /* Gradient text */
      .gradient-text {
        background: linear-gradient(135deg, #ff6b6b, #feca57, #ff9ff3);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      /* Platform colors */
      .platform-youtube {
        --color: #ff0000;
      }
      .platform-instagram {
        --color: #e1306c;
      }
      .platform-tiktok {
        --color: #00f2ea;
      }
      .platform-twitter {
        --color: #1da1f2;
      }
      .platform-facebook {
        --color: #4267b2;
      }
      .platform-vimeo {
        --color: #1ab7ea;
      }
      .platform-twitch {
        --color: #9146ff;
      }
      .platform-reddit {
        --color: #ff4500;
      }
      .platform-unknown {
        --color: #888888;
      }

      /* Progress bar */
      .progress-bar {
        transition: width 0.3s ease-out;
        background: linear-gradient(90deg, #ff6b6b, #feca57);
        box-shadow: 0 0 20px rgba(255, 107, 107, 0.4);
      }

      /* Scrollbar */
      ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }

      ::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 3px;
      }

      ::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.15);
        border-radius: 3px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.25);
      }

      /* Animations */
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .animate-fade-in {
        animation: fadeIn 0.3s ease-out forwards;
      }

      /* Tab styles */
      .tab-active {
        background: rgba(255, 255, 255, 0.1);
        color: white;
      }

      /* Quality select */
      select {
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23888'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 0.75rem center;
        background-size: 1rem;
      }
    </style>
  </head>

  <body class="text-white antialiased">
    <div id="app" class="min-h-screen flex flex-col">
      <!-- Header -->
      <header class="glass border-b border-white/5 sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-4 py-4">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <div
                class="w-10 h-10 rounded-xl bg-gradient-to-br from-red-500 to-orange-500 flex items-center justify-center"
              >
                <svg
                  class="w-6 h-6"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"
                  />
                </svg>
              </div>
              <div>
                <h1 class="text-xl font-bold">Baixar V√≠deo</h1>
                <p class="text-xs text-gray-500">v2.0 ‚Ä¢ Multi-plataforma</p>
              </div>
            </div>

            <!-- Platform icons -->
            <div class="hidden md:flex items-center gap-2">
              <span class="text-xs text-gray-500 mr-2">Suportado:</span>
              <span title="YouTube" class="text-lg">üé¨</span>
              <span title="Instagram" class="text-lg">üì∏</span>
              <span title="TikTok" class="text-lg">üéµ</span>
              <span title="X (Twitter)" class="text-lg">üê¶</span>
              <span title="Facebook" class="text-lg">üë§</span>
              <span title="Vimeo" class="text-lg">üé•</span>
            </div>
          </div>
        </div>
      </header>

      <!-- Main Content -->
      <main class="flex-1 max-w-6xl mx-auto w-full px-4 py-8">
        <!-- Input Section -->
        <section class="glass rounded-2xl p-6 mb-6">
          <div class="flex flex-col md:flex-row gap-4">
            <div class="flex-1 relative">
              <input
                type="text"
                id="urlInput"
                class="w-full bg-white/5 border border-white/10 rounded-xl px-5 py-4 text-white placeholder-gray-500 focus:outline-none focus:border-red-500/50 focus:ring-2 focus:ring-red-500/20 transition-all text-lg"
                placeholder="Cole o link do v√≠deo aqui..."
              />
              <div
                id="platformBadge"
                class="absolute right-4 top-1/2 -translate-y-1/2 hidden"
              >
                <span id="platformIcon" class="text-2xl"></span>
              </div>
            </div>

            <button
              id="previewBtn"
              onclick="getPreview()"
              class="px-8 py-4 bg-gradient-to-r from-red-600 to-orange-500 hover:from-red-500 hover:to-orange-400 text-white font-semibold rounded-xl transition-all active:scale-[0.98] disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 min-w-[160px]"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                />
              </svg>
              <span>Buscar</span>
            </button>
          </div>
        </section>

        <!-- Preview Section (Hidden by default) -->
        <section id="previewSection" class="glass rounded-2xl p-6 mb-6 hidden">
          <!-- Loading state -->
          <div id="previewLoading" class="hidden">
            <div class="flex items-center justify-center py-12">
              <div
                class="w-8 h-8 border-2 border-white/20 border-t-red-500 rounded-full animate-spin"
              ></div>
              <span class="ml-3 text-gray-400">Obtendo informa√ß√µes...</span>
            </div>
          </div>

          <!-- Preview content -->
          <div id="previewContent" class="hidden">
            <!-- Video info -->
            <div class="flex flex-col md:flex-row gap-6 mb-6">
              <div class="w-full md:w-64 flex-shrink-0">
                <img
                  id="previewThumb"
                  src=""
                  alt="Thumbnail"
                  class="w-full aspect-video object-cover rounded-xl bg-white/5"
                />
              </div>
              <div class="flex-1">
                <div
                  id="previewPlatform"
                  class="inline-flex items-center gap-2 px-3 py-1 rounded-full glass-subtle text-xs mb-3"
                >
                  <span id="previewPlatformIcon"></span>
                  <span id="previewPlatformName"></span>
                </div>
                <h2
                  id="previewTitle"
                  class="text-xl font-bold mb-2 line-clamp-2"
                ></h2>
                <div class="flex flex-wrap gap-4 text-sm text-gray-400 mb-4">
                  <span id="previewUploader" class="flex items-center gap-1">
                    <svg
                      class="w-4 h-4"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                      />
                    </svg>
                    <span></span>
                  </span>
                  <span id="previewDuration" class="flex items-center gap-1">
                    <svg
                      class="w-4 h-4"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                      />
                    </svg>
                    <span></span>
                  </span>
                  <span id="previewViews" class="flex items-center gap-1">
                    <svg
                      class="w-4 h-4"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                      />
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
                      />
                    </svg>
                    <span></span>
                  </span>
                </div>
              </div>
            </div>

            <!-- Playlist items (if applicable) -->
            <div id="playlistSection" class="hidden mb-6">
              <div class="flex items-center justify-between mb-4">
                <h3 class="font-semibold flex items-center gap-2">
                  <svg
                    class="w-5 h-5"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M4 6h16M4 10h16M4 14h16M4 18h16"
                    />
                  </svg>
                  <span id="playlistTitle">Playlist</span>
                  <span
                    id="playlistCount"
                    class="text-xs text-gray-500 font-normal"
                  ></span>
                </h3>
                <div class="flex gap-2">
                  <button
                    onclick="selectAllPlaylist()"
                    class="text-xs px-3 py-1 rounded-lg glass-subtle hover:bg-white/10 transition-colors"
                  >
                    Selecionar todos
                  </button>
                  <button
                    onclick="deselectAllPlaylist()"
                    class="text-xs px-3 py-1 rounded-lg glass-subtle hover:bg-white/10 transition-colors"
                  >
                    Limpar sele√ß√£o
                  </button>
                </div>
              </div>
              <div
                id="playlistItems"
                class="max-h-64 overflow-y-auto space-y-2"
              ></div>
            </div>

            <!-- Download options -->
            <div
              class="grid grid-cols-1 md:grid-cols-3 gap-4 p-4 glass-subtle rounded-xl mb-6"
            >
              <!-- Format -->
              <div>
                <label class="block text-xs text-gray-400 mb-2">Formato</label>
                <div class="flex gap-2">
                  <button
                    id="formatVideo"
                    onclick="setFormat('video')"
                    class="flex-1 py-3 rounded-lg glass border border-white/10 hover:border-red-500/50 transition-all flex items-center justify-center gap-2 format-btn active"
                  >
                    <svg
                      class="w-5 h-5"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"
                      />
                    </svg>
                    <span>MP4</span>
                  </button>
                  <button
                    id="formatAudio"
                    onclick="setFormat('audio')"
                    class="flex-1 py-3 rounded-lg glass border border-white/10 hover:border-red-500/50 transition-all flex items-center justify-center gap-2 format-btn"
                  >
                    <svg
                      class="w-5 h-5"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"
                      />
                    </svg>
                    <span>MP3</span>
                  </button>
                </div>
              </div>

              <!-- Video Quality -->
              <div id="videoQualitySection">
                <label class="block text-xs text-gray-400 mb-2"
                  >Qualidade do V√≠deo</label
                >
                <select
                  id="videoQuality"
                  class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-red-500/50 transition-colors"
                >
                  <option value="best">Melhor dispon√≠vel</option>
                  <option value="2160p">4K (2160p)</option>
                  <option value="1440p">1440p</option>
                  <option value="1080p">1080p (Full HD)</option>
                  <option value="720p">720p (HD)</option>
                  <option value="480p">480p</option>
                  <option value="360p">360p</option>
                </select>
              </div>

              <!-- Audio Quality -->
              <div id="audioQualitySection">
                <label class="block text-xs text-gray-400 mb-2"
                  >Qualidade do √Åudio</label
                >
                <select
                  id="audioQuality"
                  class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-red-500/50 transition-colors"
                >
                  <option value="192">192 kbps (Recomendado)</option>
                  <option value="320">320 kbps (Alta qualidade)</option>
                  <option value="128">128 kbps (Menor tamanho)</option>
                </select>
              </div>
            </div>

            <!-- Download button -->
            <button
              id="downloadBtn"
              onclick="startDownload()"
              class="w-full py-4 bg-gradient-to-r from-green-600 to-emerald-500 hover:from-green-500 hover:to-emerald-400 text-white font-bold rounded-xl transition-all active:scale-[0.99] disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-3 text-lg"
            >
              <svg
                class="w-6 h-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"
                />
              </svg>
              <span>Baixar Agora</span>
            </button>
          </div>
        </section>

        <!-- Active Downloads / Queue Section -->
        <section id="queueSection" class="glass rounded-2xl p-6 mb-6 hidden">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold flex items-center gap-2">
              <svg
                class="w-5 h-5 text-orange-500"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"
                />
              </svg>
              <span>Downloads Ativos</span>
            </h3>
            <span id="queueCount" class="text-xs text-gray-500"></span>
          </div>

          <div id="queueItems" class="space-y-3"></div>
        </section>

        <!-- History Section -->
        <section id="historySection" class="glass rounded-2xl p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold flex items-center gap-2">
              <svg
                class="w-5 h-5 text-blue-500"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                />
              </svg>
              <span>Hist√≥rico</span>
            </h3>
            <button
              onclick="clearHistory()"
              class="text-xs px-3 py-1 rounded-lg text-red-400 hover:bg-red-500/10 transition-colors"
            >
              Limpar
            </button>
          </div>

          <div id="historyItems" class="space-y-3">
            <div class="text-center py-8 text-gray-500">
              <svg
                class="w-12 h-12 mx-auto mb-3 opacity-30"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"
                />
              </svg>
              <p class="text-sm">Nenhum download realizado ainda</p>
            </div>
          </div>
        </section>
      </main>

      <!-- Footer -->
      <footer class="glass border-t border-white/5 mt-auto">
        <div
          class="max-w-6xl mx-auto px-4 py-6 flex flex-col md:flex-row items-center justify-between gap-4"
        >
          <p class="text-gray-500 text-sm">
            Powered by yt-dlp ‚Ä¢ Suporta 1000+ sites
          </p>
          <div class="flex items-center gap-4 text-sm text-gray-500">
            <a href="#" class="hover:text-white transition-colors">GitHub</a>
            <span>‚Ä¢</span>
            <span id="connectionStatus" class="flex items-center gap-1">
              <span class="w-2 h-2 rounded-full bg-yellow-500"></span>
              <span>Conectando...</span>
            </span>
          </div>
        </div>
      </footer>
    </div>

    <script>
      // ============================================================
      // STATE
      // ============================================================
      const state = {
        socket: null,
        sid: null,
        connected: false,
        currentUrl: "",
        previewData: null,
        format: "video",
        selectedPlaylistItems: [],
        activeDownloads: {},
        history: [],
      };

      const platformIcons = {
        youtube: "üé¨",
        instagram: "üì∏",
        tiktok: "üéµ",
        twitter: "üê¶",
        facebook: "üë§",
        vimeo: "üé•",
        twitch: "üéÆ",
        reddit: "ü§ñ",
        unknown: "üåê",
      };

      const platformNames = {
        youtube: "YouTube",
        instagram: "Instagram",
        tiktok: "TikTok",
        twitter: "X (Twitter)",
        facebook: "Facebook",
        vimeo: "Vimeo",
        twitch: "Twitch",
        reddit: "Reddit",
        unknown: "Outro",
      };

      // ============================================================
      // DOM ELEMENTS
      // ============================================================
      const ui = {
        urlInput: document.getElementById("urlInput"),
        platformBadge: document.getElementById("platformBadge"),
        platformIcon: document.getElementById("platformIcon"),
        previewBtn: document.getElementById("previewBtn"),
        previewSection: document.getElementById("previewSection"),
        previewLoading: document.getElementById("previewLoading"),
        previewContent: document.getElementById("previewContent"),
        previewThumb: document.getElementById("previewThumb"),
        previewTitle: document.getElementById("previewTitle"),
        previewPlatform: document.getElementById("previewPlatform"),
        previewPlatformIcon: document.getElementById("previewPlatformIcon"),
        previewPlatformName: document.getElementById("previewPlatformName"),
        previewUploader: document.getElementById("previewUploader"),
        previewDuration: document.getElementById("previewDuration"),
        previewViews: document.getElementById("previewViews"),
        playlistSection: document.getElementById("playlistSection"),
        playlistTitle: document.getElementById("playlistTitle"),
        playlistCount: document.getElementById("playlistCount"),
        playlistItems: document.getElementById("playlistItems"),
        formatVideo: document.getElementById("formatVideo"),
        formatAudio: document.getElementById("formatAudio"),
        videoQualitySection: document.getElementById("videoQualitySection"),
        audioQualitySection: document.getElementById("audioQualitySection"),
        videoQuality: document.getElementById("videoQuality"),
        audioQuality: document.getElementById("audioQuality"),
        downloadBtn: document.getElementById("downloadBtn"),
        queueSection: document.getElementById("queueSection"),
        queueCount: document.getElementById("queueCount"),
        queueItems: document.getElementById("queueItems"),
        historySection: document.getElementById("historySection"),
        historyItems: document.getElementById("historyItems"),
        connectionStatus: document.getElementById("connectionStatus"),
      };

      // ============================================================
      // SOCKET.IO
      // ============================================================
      function initSocket() {
        state.socket = io({ transports: ["websocket"] });

        state.socket.on("connect", () => {
          state.connected = true;
          updateConnectionStatus(true);
          console.log("Socket conectado");
        });

        state.socket.on("disconnect", () => {
          state.connected = false;
          updateConnectionStatus(false);
          console.log("Socket desconectado");
        });

        state.socket.on("session_id", (data) => {
          state.sid = data.sid;
        });

        state.socket.on("download_queued", (data) => {
          console.log("Download na fila:", data);
          addToQueue(data.job_id, {
            status: "queued",
            position: data.position,
          });
        });

        state.socket.on("download_status", (data) => {
          updateQueueItem(data.job_id, {
            status: data.status,
            message: data.message,
          });
        });

        state.socket.on("download_progress", (data) => {
          updateQueueItem(data.job_id, {
            status: "downloading",
            progress: data.percentage,
            speed: data.speed,
            eta: data.eta,
          });
        });

        state.socket.on("download_complete", (data) => {
          completeDownload(data);
        });

        state.socket.on("download_error", (data) => {
          failDownload(data.job_id, data.error);
        });

        state.socket.on("queue_update", (data) => {
          updateQueueDisplay(data);
        });
      }

      function updateConnectionStatus(connected) {
        const dot = ui.connectionStatus.querySelector("span:first-child");
        const text = ui.connectionStatus.querySelector("span:last-child");

        if (connected) {
          dot.className = "w-2 h-2 rounded-full bg-green-500";
          text.textContent = "Conectado";
        } else {
          dot.className = "w-2 h-2 rounded-full bg-red-500";
          text.textContent = "Desconectado";
        }
      }

      // ============================================================
      // URL INPUT
      // ============================================================
      ui.urlInput.addEventListener("input", () => {
        const url = ui.urlInput.value.trim();
        if (url) {
          const platform = detectPlatform(url);
          ui.platformBadge.classList.remove("hidden");
          ui.platformIcon.textContent = platformIcons[platform];
        } else {
          ui.platformBadge.classList.add("hidden");
        }
      });

      ui.urlInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          getPreview();
        }
      });

      function detectPlatform(url) {
        url = url.toLowerCase();
        if (url.includes("youtube.com") || url.includes("youtu.be"))
          return "youtube";
        if (url.includes("instagram.com")) return "instagram";
        if (url.includes("tiktok.com")) return "tiktok";
        if (url.includes("twitter.com") || url.includes("x.com"))
          return "twitter";
        if (url.includes("facebook.com") || url.includes("fb.watch"))
          return "facebook";
        if (url.includes("vimeo.com")) return "vimeo";
        if (url.includes("twitch.tv")) return "twitch";
        if (url.includes("reddit.com")) return "reddit";
        return "unknown";
      }

      // ============================================================
      // PREVIEW
      // ============================================================
      async function getPreview() {
        const url = ui.urlInput.value.trim();
        if (!url) {
          ui.urlInput.classList.add("border-red-500");
          setTimeout(
            () => ui.urlInput.classList.remove("border-red-500"),
            1000
          );
          return;
        }

        state.currentUrl = url;

        // Show loading
        ui.previewSection.classList.remove("hidden");
        ui.previewLoading.classList.remove("hidden");
        ui.previewContent.classList.add("hidden");
        ui.previewBtn.disabled = true;
        ui.previewBtn.innerHTML = `
          <div class="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>
          <span>Buscando...</span>
        `;

        try {
          const response = await fetch(
            `/api/preview?url=${encodeURIComponent(url)}`
          );

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || "Erro ao obter preview");
          }

          const data = await response.json();
          state.previewData = data;
          displayPreview(data);
        } catch (error) {
          console.error("Erro no preview:", error);
          alert("Erro: " + error.message);
          ui.previewSection.classList.add("hidden");
        } finally {
          ui.previewBtn.disabled = false;
          ui.previewBtn.innerHTML = `
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
            </svg>
            <span>Buscar</span>
          `;
        }
      }

      function displayPreview(data) {
        ui.previewLoading.classList.add("hidden");
        ui.previewContent.classList.remove("hidden");

        const video = data.videos[0];
        const platform = data.platform;

        // Platform badge
        ui.previewPlatformIcon.textContent = platformIcons[platform];
        ui.previewPlatformName.textContent = platformNames[platform];

        // Video info
        ui.previewThumb.src =
          video.thumbnail || "https://placehold.co/320x180/1a1a1a/333?text=";
        ui.previewTitle.textContent = video.title;

        // Uploader
        if (video.uploader) {
          ui.previewUploader.classList.remove("hidden");
          ui.previewUploader.querySelector("span:last-child").textContent =
            video.uploader;
        } else {
          ui.previewUploader.classList.add("hidden");
        }

        // Duration
        if (video.duration) {
          ui.previewDuration.classList.remove("hidden");
          ui.previewDuration.querySelector("span:last-child").textContent =
            formatDuration(video.duration);
        } else {
          ui.previewDuration.classList.add("hidden");
        }

        // Views
        if (video.view_count) {
          ui.previewViews.classList.remove("hidden");
          ui.previewViews.querySelector("span:last-child").textContent =
            formatNumber(video.view_count) + " views";
        } else {
          ui.previewViews.classList.add("hidden");
        }

        // Playlist
        if (data.is_playlist) {
          ui.playlistSection.classList.remove("hidden");
          ui.playlistTitle.textContent = data.playlist_title || "Playlist";
          ui.playlistCount.textContent = `(${data.playlist_count} v√≠deos)`;

          state.selectedPlaylistItems = data.videos.map((_, i) => i + 1);
          displayPlaylistItems(data.videos);
        } else {
          ui.playlistSection.classList.add("hidden");
          state.selectedPlaylistItems = [];
        }

        // Update quality options based on available qualities
        updateQualityOptions(data.available_qualities);
      }

      function displayPlaylistItems(videos) {
        ui.playlistItems.innerHTML = videos
          .map(
            (video, index) => `
          <label class="flex items-center gap-3 p-3 glass-subtle rounded-lg cursor-pointer hover:bg-white/5 transition-colors">
            <input 
              type="checkbox" 
              checked
              onchange="togglePlaylistItem(${index + 1})"
              class="w-4 h-4 rounded border-white/20 bg-white/5 text-red-500 focus:ring-red-500/50"
            />
            <img 
              src="${video.thumbnail || ""}" 
              alt="" 
              class="w-16 h-9 object-cover rounded bg-white/5"
            />
            <div class="flex-1 min-w-0">
              <p class="text-sm font-medium truncate">${video.title}</p>
              <p class="text-xs text-gray-500">${
                video.duration ? formatDuration(video.duration) : ""
              }</p>
            </div>
          </label>
        `
          )
          .join("");
      }

      function togglePlaylistItem(index) {
        const idx = state.selectedPlaylistItems.indexOf(index);
        if (idx > -1) {
          state.selectedPlaylistItems.splice(idx, 1);
        } else {
          state.selectedPlaylistItems.push(index);
          state.selectedPlaylistItems.sort((a, b) => a - b);
        }
      }

      function selectAllPlaylist() {
        state.selectedPlaylistItems = state.previewData.videos.map(
          (_, i) => i + 1
        );
        ui.playlistItems.querySelectorAll("input").forEach((cb) => {
          cb.checked = true;
        });
      }

      function deselectAllPlaylist() {
        state.selectedPlaylistItems = [];
        ui.playlistItems.querySelectorAll("input").forEach((cb) => {
          cb.checked = false;
        });
      }

      function updateQualityOptions(qualities) {
        // Update video quality dropdown based on available qualities
        if (qualities && qualities.length > 0) {
          const options = ui.videoQuality.querySelectorAll("option");
          options.forEach((opt) => {
            if (opt.value !== "best") {
              const available = qualities.includes(opt.value);
              opt.disabled = !available;
              if (!available) {
                opt.textContent = opt.textContent.replace(
                  " (Indispon√≠vel)",
                  ""
                );
                opt.textContent += " (Indispon√≠vel)";
              }
            }
          });
        }
      }

      // ============================================================
      // FORMAT SELECTION
      // ============================================================
      function setFormat(format) {
        state.format = format;

        // Update buttons
        document.querySelectorAll(".format-btn").forEach((btn) => {
          btn.classList.remove("active", "bg-red-500/20", "border-red-500/50");
        });

        if (format === "video") {
          ui.formatVideo.classList.add(
            "active",
            "bg-red-500/20",
            "border-red-500/50"
          );
          ui.videoQualitySection.style.opacity = "1";
          ui.videoQualitySection.style.pointerEvents = "auto";
        } else {
          ui.formatAudio.classList.add(
            "active",
            "bg-red-500/20",
            "border-red-500/50"
          );
          ui.videoQualitySection.style.opacity = "0.5";
          ui.videoQualitySection.style.pointerEvents = "none";
        }
      }

      // ============================================================
      // DOWNLOAD
      // ============================================================
      function startDownload() {
        if (!state.currentUrl || !state.previewData) {
          return;
        }

        const data = {
          url: state.currentUrl,
          format: state.format,
          video_quality: ui.videoQuality.value,
          audio_quality: ui.audioQuality.value,
        };

        if (
          state.previewData.is_playlist &&
          state.selectedPlaylistItems.length > 0
        ) {
          data.playlist_items = state.selectedPlaylistItems;
        }

        // Send via socket
        state.socket.emit("start_download", data);

        // Add placeholder to queue
        const tempId = "pending-" + Date.now();
        addToQueue(tempId, {
          title: state.previewData.videos[0]?.title || "Preparando...",
          platform: state.previewData.platform,
          status: "queued",
          progress: 0,
        });

        // Reset preview
        ui.previewSection.classList.add("hidden");
        ui.urlInput.value = "";
        state.currentUrl = "";
        state.previewData = null;
      }

      // ============================================================
      // QUEUE MANAGEMENT
      // ============================================================
      function addToQueue(jobId, data) {
        state.activeDownloads[jobId] = {
          ...data,
          job_id: jobId,
        };
        renderQueue();
      }

      function updateQueueItem(jobId, data) {
        if (state.activeDownloads[jobId]) {
          state.activeDownloads[jobId] = {
            ...state.activeDownloads[jobId],
            ...data,
          };
          renderQueue();
        }
      }

      function completeDownload(data) {
        delete state.activeDownloads[data.job_id];
        renderQueue();

        // Add to history
        loadHistory();

        // Auto-download file
        if (data.is_playlist) {
          // Multiple files
          data.files.forEach((file) => {
            downloadFile(file.url, file.filename);
          });
        } else {
          downloadFile(data.url, data.filename);
        }
      }

      function downloadFile(url, filename) {
        const link = document.createElement("a");
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      function failDownload(jobId, error) {
        if (state.activeDownloads[jobId]) {
          state.activeDownloads[jobId].status = "failed";
          state.activeDownloads[jobId].error = error;
          renderQueue();

          setTimeout(() => {
            delete state.activeDownloads[jobId];
            renderQueue();
          }, 5000);
        }
        alert("Erro no download: " + error);
      }

      function renderQueue() {
        const items = Object.values(state.activeDownloads);

        if (items.length === 0) {
          ui.queueSection.classList.add("hidden");
          return;
        }

        ui.queueSection.classList.remove("hidden");
        ui.queueCount.textContent = `${items.length} item(s)`;

        ui.queueItems.innerHTML = items
          .map((item) => {
            const statusColors = {
              queued: "bg-yellow-500",
              fetching_info: "bg-blue-500",
              downloading: "bg-green-500",
              processing: "bg-purple-500",
              completed: "bg-green-500",
              failed: "bg-red-500",
            };

            const statusLabels = {
              queued: "Na fila",
              fetching_info: "Obtendo info...",
              downloading: "Baixando",
              processing: "Processando",
              completed: "Conclu√≠do",
              failed: "Erro",
            };

            return `
            <div class="glass-subtle rounded-xl p-4 animate-fade-in">
              <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-3">
                  <span class="text-xl">${
                    platformIcons[item.platform] || "üåê"
                  }</span>
                  <div>
                    <p class="font-medium truncate max-w-xs">${
                      item.title || "Processando..."
                    }</p>
                    <div class="flex items-center gap-2 text-xs text-gray-500">
                      <span class="w-2 h-2 rounded-full ${
                        statusColors[item.status] || "bg-gray-500"
                      }"></span>
                      <span>${statusLabels[item.status] || item.status}</span>
                      ${item.speed ? `<span>‚Ä¢ ${item.speed}</span>` : ""}
                      ${item.eta ? `<span>‚Ä¢ ETA: ${item.eta}</span>` : ""}
                    </div>
                  </div>
                </div>
                <span class="text-2xl font-bold ${
                  item.progress >= 100 ? "text-green-500" : "text-white"
                }">
                  ${Math.round(item.progress || 0)}%
                </span>
              </div>
              <div class="h-2 w-full bg-white/10 rounded-full overflow-hidden">
                <div 
                  class="h-full progress-bar" 
                  style="width: ${item.progress || 0}%"
                ></div>
              </div>
            </div>
          `;
          })
          .join("");
      }

      function updateQueueDisplay(data) {
        // Full queue update from server
        data.items.forEach((item) => {
          state.activeDownloads[item.job_id] = item;
        });
        renderQueue();
      }

      // ============================================================
      // HISTORY
      // ============================================================
      async function loadHistory() {
        try {
          const response = await fetch("/api/history?per_page=10");
          const data = await response.json();
          state.history = data.items;
          renderHistory();
        } catch (error) {
          console.error("Erro ao carregar hist√≥rico:", error);
        }
      }

      function renderHistory() {
        if (state.history.length === 0) {
          ui.historyItems.innerHTML = `
            <div class="text-center py-8 text-gray-500">
              <svg class="w-12 h-12 mx-auto mb-3 opacity-30" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
              </svg>
              <p class="text-sm">Nenhum download realizado ainda</p>
            </div>
          `;
          return;
        }

        ui.historyItems.innerHTML = state.history
          .map((item) => {
            const date = new Date(item.created_at);
            const formattedDate = date.toLocaleDateString("pt-BR", {
              day: "2-digit",
              month: "2-digit",
              hour: "2-digit",
              minute: "2-digit",
            });

            const statusColors = {
              completed: "text-green-500",
              failed: "text-red-500",
              downloading: "text-yellow-500",
            };

            return `
            <div class="glass-subtle rounded-xl p-4 flex items-center gap-4">
              ${
                item.thumbnail
                  ? `<img src="${item.thumbnail}" alt="" class="w-20 h-12 object-cover rounded-lg bg-white/5">`
                  : ""
              }
              <div class="flex-1 min-w-0">
                <p class="font-medium truncate">${
                  item.title || "Sem t√≠tulo"
                }</p>
                <div class="flex items-center gap-3 text-xs text-gray-500">
                  <span>${platformIcons[item.platform] || "üåê"} ${
              platformNames[item.platform] || "Outro"
            }</span>
                  <span>‚Ä¢</span>
                  <span class="${statusColors[item.status] || ""}">${
              item.status === "completed" ? "Conclu√≠do" : item.status
            }</span>
                  <span>‚Ä¢</span>
                  <span>${formattedDate}</span>
                  ${
                    item.file_size
                      ? `<span>‚Ä¢ ${formatBytes(item.file_size)}</span>`
                      : ""
                  }
                </div>
              </div>
              ${
                item.status === "completed" && item.file_path
                  ? `
                <a 
                  href="/api/files/${item.file_path.split(/[\\/]/).pop()}"
                  download
                  class="px-4 py-2 rounded-lg glass hover:bg-white/10 transition-colors text-sm"
                >
                  Baixar
                </a>
              `
                  : ""
              }
            </div>
          `;
          })
          .join("");
      }

      async function clearHistory() {
        if (!confirm("Tem certeza que deseja limpar todo o hist√≥rico?")) {
          return;
        }

        try {
          await fetch("/api/history", { method: "DELETE" });
          state.history = [];
          renderHistory();
        } catch (error) {
          console.error("Erro ao limpar hist√≥rico:", error);
        }
      }

      // ============================================================
      // UTILITIES
      // ============================================================
      function formatDuration(seconds) {
        if (!seconds) return "";
        const h = Math.floor(seconds / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        const s = Math.floor(seconds % 60);

        if (h > 0) {
          return `${h}:${m.toString().padStart(2, "0")}:${s
            .toString()
            .padStart(2, "0")}`;
        }
        return `${m}:${s.toString().padStart(2, "0")}`;
      }

      function formatNumber(num) {
        if (num >= 1000000) {
          return (num / 1000000).toFixed(1) + "M";
        }
        if (num >= 1000) {
          return (num / 1000).toFixed(1) + "K";
        }
        return num.toString();
      }

      function formatBytes(bytes) {
        if (bytes === 0) return "0 B";
        const k = 1024;
        const sizes = ["B", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + " " + sizes[i];
      }

      // ============================================================
      // INIT
      // ============================================================
      document.addEventListener("DOMContentLoaded", () => {
        initSocket();
        loadHistory();
        setFormat("video"); // Default format
      });
    </script>
  </body>
</html>
